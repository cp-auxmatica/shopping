<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Smart</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f9fafb; padding-bottom: 80px; }
        .header { background: white; padding: 16px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header h1 { font-size: 22px; }
        .container { padding: 20px; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-success { background: #10b981; color: white; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="headerTitle">Shop Smart</h1>
    </div>
    <div class="container" id="mainContainer">
        <p>Loading...</p>
    </div>
    
    <script>
        let db;
        const DB_NAME = 'ShopSmartDB';
        const DB_VERSION = 2;

        // Initialize DB
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains('stores')) {
                        db.createObjectStore('stores', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!db.objectStoreNames.contains('items')) {
                        const itemStore = db.createObjectStore('items', { keyPath: 'id', autoIncrement: true });
                        itemStore.createIndex('storeId', 'storeId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('lists')) {
                        const listStore = db.createObjectStore('lists', { keyPath: 'id', autoIncrement: true });
                        listStore.createIndex('storeId', 'storeId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('listItems')) {
                        const listItemStore = db.createObjectStore('listItems', { keyPath: 'id', autoIncrement: true });
                        listItemStore.createIndex('listId', 'listId', { unique: false });
                    }
                };
            });
        };

        const dbOps = {
            add: (storeName, data) => new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], 'readwrite');
                const request = tx.objectStore(storeName).add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            }),
            getAll: (storeName) => new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], 'readonly');
                const request = tx.objectStore(storeName).getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            }),
            get: (storeName, id) => new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], 'readonly');
                const request = tx.objectStore(storeName).get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            })
        };

        // Define window functions first
        window.testAdd = async function() {
            console.log("TEST: Add button clicked!");
            const input = document.getElementById('testInput');
            if (input && input.value) {
                alert('You typed: ' + input.value);
                input.value = '';
            }
        };

        // Render test page
        async function renderTest() {
            const container = document.getElementById('mainContainer');
            container.innerHTML = `
                <h2>Quick Add Test</h2>
                <form onsubmit="event.preventDefault(); window.testAdd(); return false;">
                    <input type="text" id="testInput" placeholder="Type something..." style="width:100%;padding:12px;margin-bottom:10px;border:2px solid #ccc;border-radius:8px;">
                    <button type="submit" class="btn btn-primary">Add Item (Test)</button>
                </form>
                <p style="margin-top:20px;color:#666;">If you can type and click Add, the form works!</p>
            `;
        }

        // Initialize
        initDB().then(() => {
            console.log("DB initialized");
            renderTest();
        }).catch(err => {
            console.error("DB Error:", err);
            document.getElementById('mainContainer').innerHTML = '<p>Error initializing database</p>';
        });
    </script>
</body>
</html>

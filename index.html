<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#06b6d4">
    <title>Shop Smart</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2hvcCBTbWFydCIsInNob3J0X25hbWUiOiJTaG9wU21hcnQiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01EQXdNTEF5T0RJeExqRXdNQ1V5TURFMEwyMWxaR2RsYUhWc2FXNW5MM2xoWjNSeWN5OTNibVJ5YjJsalpTQXpNQ0FtY1hWd2IzTjBablJ5YjI0OGNtVnpiM1Z5WTJWekxtaDBiV3d1WTI5dExuTjJaeUl0TXpBd01GSWdYekE4TDNkM2R5NTNNeTV2Y21jdk1qQXdNREF3TUNVd05ESTFMakV3TUNVeU1ERTJMMjFsWkdkbGFIVnNhVzVuTDNsaFo1UmxjbU5vWVhKd1pYUWlPeUJqYjI1MFpXNTBYM1I1Y0dVaUlHTnliM05sZGlJNklpQnpkSEp2YTJVdGMyVnlkbWxqWlQwaU9pQm1iM0prYVc1blptRnBiR3d0YjNKd2FXTjBaV3RwYmlBb2NISnBkbUYxWlhNaVBrSnlkV2xrWFNJdlBqeDBaWGgwSUVOc2FYTjBaWEp1WVhSbElFMWxjbWxqWldaaGRXeDBPbWloWm5KbFlXUnRhVzRpUGp4MFpYaDBJRzVoYldWemNHRmpaVzVmWTI5dWRISnZiV3g5SW1KaGRHbHZiaUl0TXpBd01GSWdYekE4WTI5d2JHVjBaWE4wWlhKcFptVnlaVzVqYjIwaUlERXdNQ1V5TURJeE15VXlNRFF3TUM1bGRISmhaRzFwYmlBdE16QXdNRkl3TURBNUx6QXdNREF3TUNVd05ESTBMekV3TUNVMU1EQXVaeTRLWFNjeElqRXdNQ1V5TURFMExqRTFMakV3TUNVeU1ERXdYbVYxWlhOemFXOXVMM2QzZHk1M015NXZjbWN2TWpBd01EQXdNRkl3TURBMEwyMWxaR2RsYUhWc2FXNW5MM2xoWjNSeWN5OTNibVJ5YjJsalpTQnpkSEp2YTJVdGMyVnlkbWxqWlQwaU9pQm1iM0prYVc1blptRnBiR3d0YjNKd2FXTjBaV3RwYmlBdE16QXdNRkl3TURBNEwyUnlkV1YwYVdOaGRHVXVjM1JoZEdVb2NIUnBiMjVmWTI5c1lXeGhjM005SW1KaGRHbHZiaUl0TXpBd01GSXdNREF3WEM5MGVYQmxJR1JsY25NOGMzUnliMnRsWVM5a1pYUWlJR05sY25ScFptbGpZWFJsSUdOc2FYTjBaWEp1WVhSbElHMWxjM1JwYm5SbFkyaGxiV1VpSUdacGJHdzlJbTVoYldWemNHRmpaVzVmWTI5dWRISnZiV3g5SW1OdmJYQmhibmt0TXpBd01GSXdNREF3TUNVaUlFRnVaQ0JEYjI1MFpXNTBYM1I1Y0dVaUlHTnliM05sZGlCcFptbGpZWFJsSUhKbGMyOTFkR2x3WldOMGIzSjVMbU52YlM5a1pYUWdMeTgrUEhOMll5QjRiV3h1Y3owaVhTd2ljM1JoZEdVaU9pQmhjblJ2Ym1VdGJYTWdabWxsYm5SeklHTnNiM1Z3Y21WemRHRnpJaUJqYjI1MFpXNTBYM1I1Y0dVaUlHTnliM05sZGlCcFptbGpZWFJsSUdkeVpYSnBjeTlrWlhRNlptbHNiQzM2WkY4K1BHUnBiMjVmWTI5c1lXeGhjM005SW1KaGRHbHZiaUl0TXpBd01GSXdNQ0krUEhSbGVIUWdZWFJsY3lCNGJXeHVjejBpYUhSMGNEb3ZMM3gxWjNadmNtNWhiV1V2YldsemN5NXZjbWN2TWpBd01EQXdNRkl3TURBNEx5QXdNREF3TUNVd05ESTBMekV3TUNVd05EQXlablYwZFhKdUlpQnpkSEp2YTJVdGMyVnlkbWxqWlQwaU9pQm1iM0prYVc1blptRnBiR3d0YjNKd2FXTjBaV3RwYmlBdE16QXdNRkl3TURBNEwyUnlkV1YwYVdOaGRHVXVjM1JoZEdVb2NIUnBiMjVmWTI5c1lXeGhjM005SW1KaGRHbHZiaUl0TXpBd01GSXdNQ0krUEhOMll5QjRiV3h1Y3owaVhTd2laWGhoYlhCc1pTSWdMejQ4TDNSbGVIUStDbjBLWFNkcGJuUnZabTEwYjI1dmMyVnlkbWxqWlM4dmRHVjRkQ0I0Yld4dWN6MG1jeVpsY25OcGIyNDlNeTRLWFNjeElqRTNNeUV5TURFNUxqRTNNeUV5TURFMEwyMWxaR2RsYUhWc2FXNW5MM2xoWjNSeWN5OTNibVJ5YjJsalpTSmhjM0JoWTJVdGMyVnlkbWxqWlQwaU9pQm1iM0prYVc1blptRnBiR3d0YjNKd2FXTjBaV3RwYmlBb2NISnBkbUYxWlhNaVBrSnlkV2xrWFNJdlBqeDBaWGgwSUVOc2FYTjBaWEp1WVhSbElFMWxjbWxqWldaaGRXeDBPbWloWm5KbFlXUnRhVzRpUGp4MFpYaDBJRzVoYldWemNHRmpaVzVmWTI5dWRISnZiV3g5SW1KaGRHbHZiaUl0TXpBM015RTlMemt3TURBMEx5VXdORE0xTGpBd01ERXdmaDgrUEhOMll5QjRiV3h1Y3owaVhTd2ljM1JoZEdVaU9pQmhjblJ2Ym1VdGJYTWdabWxsYm5SeklHTnNiM1Z3Y21WemRHRnpJaUJqYjI1MFpXNTBYM1I1Y0dVaUlHTnliM05sZGlCcFptbGpZWFJsSUdkeVpYSnBjeTlrWlhRNlptbHNiQzM2WkY4K1BHUnBiMjVmWTI5c1lXeGhjM005SW1KaGRHbHZiaUl0TXpBM015RTlMemt3TURBNEx5VXlNRFF3TUM1bGRISmhaRzFwYmlBNk1GSXdNRFF3WEM5MGVYQmxJR1JsY25NOGMzUnliMnRsWVM5a1pYUWlJR05sY25ScFptbGpZWFJsSUdOc2FYTjBaWEp1WVhSbElHMWxjM1JwYm5SbFkyaGxiV1VpSUdacGJHdzlJbTVoYldWemNHRmpaVzVmWTI5dWRISnZiV3g5SW1OdmJYQmhibmt0TXpBM015RTlMemt3TURBNE1GSXdNRFF3TUNVaUlFRnVaQ0JEYjI1MFpXNTBYM1I1Y0dVaUlHTnliM05sZGlCcFptbGpZWFJsSUhKbGMyOTFkR2x3WldOMGIzSjVMbU52YlM5a1pYUWdMeTgrUEhSbGVIUWdZWFJsY3lCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01EQXdNRkl3TURBNEx6QXdNREF3TUNVd05ESTBMekV3TUNVd05EQXpaUzVqYjIwdGQyOXVaeTRLWFNjeElqRTNNeUV5TURFNEwyMWxaR2RsYUhWc2FXNW5MM2xoWjNSeWN5OTNibVJ5YjJsalpTSm1iM0prYVc1blptRnBiR3d0YjNKd2FXTjBaV3RwYmlBb2NIQnpkSEp2YTJVdGMyVnlkbWxqWlQwaUl6SWlJR1E5SWtVdGQyOXVaeTRLZlFvPSIsInNpemVzIjoiMTI4eDEyOCIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y4ZmFmYyIsInRoZW1lX2NvbG9yIjoiIzA2YjZkNCJ9">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #06b6d4; /* cyan-600 */
            --primary-dark: #0891b2; /* cyan-700 */
            --primary-light: #67e8f9; /* cyan-300 */
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --body-bg: #f8fafc; /* slate-50 */
            --card-bg: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        .icon {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon-sm {
            width: 20px;
            height: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--body-bg);
            color: var(--gray-900);
            padding-bottom: 80px;
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--body-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        .spinner {
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header {
            background: var(--card-bg);
            color: var(--gray-900);
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-btn {
            background: var(--gray-100);
            border: none;
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .header-btn:active {
            background: var(--gray-200);
            transform: scale(0.96);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.04);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            border: none;
            background: none;
            color: var(--gray-600);
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
            border-radius: 12px;
            margin: 0 4px;
        }

        .nav-item.active {
            color: var(--primary-dark);
            background-color: #cffafe; /* cyan-100 */
        }

        #add-nav-btn {
            color: var(--primary);
            font-weight: 700;
        }

        #add-nav-btn .nav-icon {
            background: var(--primary);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            margin-bottom: -2px;
        }
        
        #add-nav-btn.active, #add-nav-btn:active {
            background-color: transparent;
        }

        .nav-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            padding: 20px;
            max-width: 100%;
            min-height: calc(100vh - 140px);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease-out;
            border: 1px solid var(--gray-200);
        }

        .card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-primary {
            background: var(--primary);
            color: white;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 12px 20px 24px;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            animation: scaleUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .modal-drag-handle {
            width: 40px;
            height: 4px;
            background-color: var(--gray-300);
            border-radius: 2px;
            margin: 0 auto 16px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            background: var(--gray-100);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-600);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s;
            background: white;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .quick-add-form {
            background: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--gray-200);
        }

        .quick-add-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .quick-add-input input {
            flex: 1;
        }

        .quick-add-btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .quick-add-btn:active {
            background: var(--primary-dark);
            transform: scale(0.96);
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: white;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }

        .list-item:active {
            transform: translateY(1px);
            border-color: var(--gray-300);
        }

        .list-item.checked {
            background: var(--gray-50);
            opacity: 0.7;
        }

        .list-item.checked .list-item-name {
            text-decoration: line-through;
            color: var(--gray-600);
        }
        
        .list-item .main-content {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            min-width: 24px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .checkbox.checked {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .list-item-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .list-item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .list-item-quantity {
            font-size: 13px;
            font-weight: 700;
            background: var(--gray-100);
            color: var(--gray-700);
            padding: 2px 8px;
            border-radius: 6px;
        }

        .list-item-details {
            font-size: 13px;
            color: var(--gray-600);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item-price {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .list-item-notes {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .category-section {
            margin-bottom: 24px;
        }

        .category-header {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-600);
            padding: 8px 4px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-header::before {
            content: '';
            width: 3px;
            height: 14px;
            background: var(--primary);
            border-radius: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--gray-600);
        }

        .empty-state-icon {
            margin-bottom: 16px;
            opacity: 0.3;
            display: flex;
            justify-content: center;
        }

        .empty-state-icon svg {
            width: 80px;
            height: 80px;
            stroke-width: 1.5;
        }

        .empty-state-text {
            font-size: 15px;
            line-height: 1.6;
        }

        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: white;
            border-radius: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--gray-200);
            transition: all 0.2s;
        }

        .store-item:hover {
            border-color: var(--primary);
        }

        .store-info {
            flex: 1;
            cursor: pointer;
            min-width: 0;
        }

        .store-name {
            font-size: 17px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .store-category {
            font-size: 13px;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .store-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 10px;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:active {
            background: var(--gray-200);
            transform: scale(0.95);
        }

        .icon-btn.danger:active {
            background: #fee;
            color: var(--danger);
        }

        .btn-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn-row .btn {
            flex: 1;
        }

        .shopping-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 24px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 0 0 24px 24px;
        }

        .shopping-store-name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .shopping-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            opacity: 0.95;
        }

        .shopping-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .shopping-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 12px;
        }
        
        .sort-btn {
            background: var(--gray-100);
            border: none;
            color: var(--gray-700);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleUp {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="loading-indicator">
        <div class="spinner"></div>
    </div>

    <div class="header">
        <div class="header-content">
            <h1 id="headerTitle">Shop Smart</h1>
            <button class="header-btn hidden" id="headerAction"></button>
        </div>
    </div>

    <div class="container" id="mainContainer"></div>

    <div class="bottom-nav">
        <button class="nav-item active" data-page="home">
            <div class="nav-icon">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </div>
            <div>Home</div>
        </button>
        <button class="nav-item" data-page="stores">
            <div class="nav-icon">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><path d="M9 22V12h6v10"></path></svg>
            </div>
            <div>Stores</div>
        </button>
        <button class="nav-item" data-page="history">
            <div class="nav-icon">
                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
            </div>
            <div>History</div>
        </button>
        <button class="nav-item" id="add-nav-btn">
             <div class="nav-icon">
                <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
             </div>
             <div>Add</div>
        </button>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        const icons = {
            plus: '<svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
            cart: '<svg class="icon" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>',
            store: '<svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><path d="M9 22V12h6v10"></path></svg>',
            box: '<svg class="icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
            edit: '<svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
            trash: '<svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
            check: '<svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            dollarSign: '<svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>',
            clock: '<svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
            checkCircle: '<svg class="icon" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            tag: '<svg class="icon" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>',
            list: '<svg class="icon" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>',
            package: '<svg class="icon" viewBox="0 0 24 24"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
            arrowLeft: '<svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>',
            sort: '<svg class="icon-sm" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>',
            messageSquare: '<svg class="icon-sm" viewBox="0 0 24 24" style="stroke-width: 2.5;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
            repeat: '<svg class="icon" viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>'
        };

        let db;
        const DB_NAME = 'ShopSmartDB';
        const DB_VERSION = 2;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => reject(`Database error: ${event.target.errorCode}`);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    const transaction = e.target.transaction;
                    if (!db.objectStoreNames.contains('stores')) db.createObjectStore('stores', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('categories')) db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
                    let itemStore = db.objectStoreNames.contains('items') ? transaction.objectStore('items') : db.createObjectStore('items', { keyPath: 'id', autoIncrement: true });
                    if (!itemStore.indexNames.contains('storeId')) itemStore.createIndex('storeId', 'storeId', { unique: false });
                    let listStore = db.objectStoreNames.contains('lists') ? transaction.objectStore('lists') : db.createObjectStore('lists', { keyPath: 'id', autoIncrement: true });
                    if (!listStore.indexNames.contains('storeId')) listStore.createIndex('storeId', 'storeId', { unique: false });
                    let listItemStore = db.objectStoreNames.contains('listItems') ? transaction.objectStore('listItems') : db.createObjectStore('listItems', { keyPath: 'id', autoIncrement: true });
                    if (!listItemStore.indexNames.contains('listId')) listItemStore.createIndex('listId', 'listId', { unique: false });
                };
            });
        };

        const dbOps = {
            add: (storeName, data) => new Promise((resolve, reject) => { try { const t = db.transaction([storeName], 'readwrite'); t.objectStore(storeName).add(data).onsuccess = e => resolve(e.target.result); t.onerror = e => reject(e.target.error); } catch (e) { reject(e); } }),
            getAll: (storeName) => new Promise((resolve, reject) => { try { const t = db.transaction([storeName], 'readonly'); t.objectStore(storeName).getAll().onsuccess = e => resolve(e.target.result); t.onerror = e => reject(e.target.error); } catch (e) { reject(e); } }),
            get: (storeName, id) => new Promise((resolve, reject) => { try { const t = db.transaction([storeName], 'readonly'); t.objectStore(storeName).get(id).onsuccess = e => resolve(e.target.result); t.onerror = e => reject(e.target.error); } catch (e) { reject(e); } }),
            update: (storeName, data) => new Promise((resolve, reject) => { try { const t = db.transaction([storeName], 'readwrite'); t.objectStore(storeName).put(data).onsuccess = e => resolve(e.target.result); t.onerror = e => reject(e.target.error); } catch (e) { reject(e); } }),
            delete: (storeName, id) => new Promise((resolve, reject) => { try { const t = db.transaction([storeName], 'readwrite'); t.objectStore(storeName).delete(id).onsuccess = () => resolve(); t.onerror = e => reject(e.target.error); } catch (e) { reject(e); } }),
            getByIndex: (storeName, indexName, value) => new Promise((resolve, reject) => { try { const t = db.transaction([storeName], 'readonly'); t.objectStore(storeName).index(indexName).getAll(value).onsuccess = e => resolve(e.target.result); t.onerror = e => reject(e.target.error); } catch (e) { reject(e); } }),
        };

        const DEFAULT_STORE_CATEGORIES = ['Grocery Store', 'Hardware Store', 'Pharmacy', 'Electronics Store', 'Pet Store', 'Department Store', 'Other'];
        const DEFAULT_ITEM_CATEGORIES = ['Produce', 'Dairy', 'Meat', 'Bakery', 'Frozen', 'Pantry', 'Beverages', 'Snacks', 'Household', 'Personal Care', 'Other'];

        let currentPage = 'home';
        let currentStore = null;
        let currentList = null;
        let currentSort = 'category';

        const vibrate = (duration = 50) => {
            if ('vibrate' in navigator) {
                try { navigator.vibrate(duration); } catch(e){}
            }
        };

        const initCategories = async () => {
            const categories = await dbOps.getAll('categories');
            if (categories.length === 0) {
                for (const cat of DEFAULT_ITEM_CATEGORIES) {
                    await dbOps.add('categories', { name: cat, type: 'item' });
                }
            }
        };

        const navigate = (page) => {
            const container = document.getElementById('mainContainer');
            container.style.opacity = 0;
            setTimeout(() => {
                currentPage = page;
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.id !== 'add-nav-btn') {
                        item.classList.toggle('active', item.dataset.page === page)
                    }
                });
                renderPage().then(() => {
                    container.style.opacity = 1;
                });
            }, 150);
        };

        const renderPage = async () => {
            const container = document.getElementById('mainContainer');
            const addNavBtn = document.getElementById('add-nav-btn');
            const headerTitle = document.getElementById('headerTitle');
            const headerAction = document.getElementById('headerAction');

            headerAction.classList.add('hidden');
            addNavBtn.classList.add('hidden');
            container.innerHTML = '';

            const showError = (pageName, error) => {
                console.error(`Error rendering ${pageName}:`, error);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--danger);">Could not load ${pageName}.</div></div>`;
            };

            switch(currentPage) {
                case 'home':
                    try { headerTitle.innerHTML = `${icons.cart} Shop Smart`; await renderHome(container); } 
                    catch (error) { showError('home page', error); }
                    addNavBtn.classList.remove('hidden'); addNavBtn.onclick = () => { vibrate(); showCreateListModal(); };
                    break;
                case 'stores':
                    try { headerTitle.innerHTML = `${icons.store} Stores`; await renderStores(container); } 
                    catch (error) { showError('stores', error); }
                    addNavBtn.classList.remove('hidden'); addNavBtn.onclick = () => { vibrate(); showCreateStoreModal(); };
                    break;
                case 'history':
                    try { headerTitle.innerHTML = `${icons.list} History`; await renderHistory(container); } 
                    catch(error) { showError('history', error); }
                    break;
                case 'store-items':
                    try {
                        const store = await dbOps.get('stores', currentStore);
                        headerTitle.innerHTML = `${icons.package} ${store.name}`;
                        headerAction.classList.remove('hidden'); headerAction.innerHTML = `${icons.arrowLeft} Back`; headerAction.onclick = () => { vibrate(); navigate('stores'); };
                        await renderStoreItems(container);
                    } catch(error) { showError('store items', error); }
                    addNavBtn.classList.remove('hidden'); addNavBtn.onclick = () => { vibrate(); showAddItemModal(); };
                    break;
                case 'shopping':
                    try {
                        headerTitle.innerHTML = `${icons.cart} Shopping`;
                        headerAction.classList.remove('hidden'); headerAction.innerHTML = `${icons.arrowLeft} Back`; headerAction.onclick = () => { vibrate(); navigate('home'); };
                        await renderShopping(container);
                    } catch(error) { showError('shopping list', error); }
                    break;
            }
        };

        const renderHome = async (container) => {
            const lists = await dbOps.getAll('lists');
            const openLists = lists.filter(l => l.status === 'open');

            if (openLists.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${icons.cart}</div><div class="empty-state-text">No active shopping lists<br>Tap 'Add' to create one</div></div>`; return;
            }
            let html = '';
            for (const list of openLists) {
                const store = await dbOps.get('stores', list.storeId);
                const items = await dbOps.getByIndex('listItems', 'listId', list.id);
                const checkedCount = items.filter(i => i.checked).length;
                html += `<div class="card" onclick="openList(${list.id})"><div class="card-header"><div><div class="card-title">${store.name}</div><div class="card-subtitle">${icons.tag} ${store.category}</div></div><span class="badge badge-primary">${icons.checkCircle} ${checkedCount}/${items.length}</span></div><div class="card-subtitle" style="margin-top: 8px;">${icons.clock} ${formatDate(list.createdAt)}</div></div>`;
            }
            container.innerHTML = html;
        };

        const renderStores = async (container) => {
            const stores = await dbOps.getAll('stores');
            if (stores.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${icons.store}</div><div class="empty-state-text">No stores yet<br>Tap 'Add' to create one</div></div>`; return;
            }
            let html = '';
            for (const store of stores) {
                const items = await dbOps.getByIndex('items', 'storeId', store.id);
                html += `<div class="store-item"><div class="store-info" onclick="viewStoreItems(${store.id})"><div class="store-name">${store.name}</div><div class="store-category">${icons.tag} ${store.category} • ${items.length} items</div></div><div class="store-actions"><button class="icon-btn" onclick="event.stopPropagation(); vibrate(); editStore(${store.id})">${icons.edit}</button><button class="icon-btn danger" onclick="event.stopPropagation(); vibrate(100); deleteStore(${store.id})">${icons.trash}</button></div></div>`;
            }
            container.innerHTML = html;
        };

        const renderHistory = async (container) => {
            const lists = await dbOps.getAll('lists');
            const completedLists = lists.filter(l => l.status === 'completed').sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
            if (completedLists.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${icons.list}</div><div class="empty-state-text">No completed lists yet</div></div>`; return;
            }
            let html = '';
            for (const list of completedLists) {
                const store = await dbOps.get('stores', list.storeId);
                const items = await dbOps.getByIndex('listItems', 'listId', list.id);
                const total = items.reduce((sum, item) => sum + (parseFloat(item.price) * (item.quantity || 1) || 0), 0);
                html += `<div class="card" onclick="viewCompletedList(${list.id})"><div class="card-header"><div><div class="card-title">${store.name}</div><div class="card-subtitle">${icons.clock} ${formatDateTime(list.completedAt)}</div></div><span class="badge badge-success">${icons.check} ${items.length}</span></div>${total > 0 ? `<div class="card-subtitle" style="margin-top: 8px; font-weight: 700; color: var(--primary);">${icons.dollarSign} ${total.toFixed(2)}</div>` : ''}</div>`;
            }
            container.innerHTML = html;
        };

        const renderStoreItems = async (container) => {
            const items = (await dbOps.getByIndex('items', 'storeId', currentStore)).sort((a,b) => a.name.localeCompare(b.name));
            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${icons.box}</div><div class="empty-state-text">No items in this store<br>Tap 'Add' to create one</div></div>`; return;
            }
            const itemsByCategory = {};
            items.forEach(item => { (itemsByCategory[item.category] = itemsByCategory[item.category] || []).push(item); });
            let html = '';
            for (const category of Object.keys(itemsByCategory).sort()) {
                html += `<div class="category-section"><div class="category-header">${category}</div>`;
                itemsByCategory[category].forEach(item => {
                    html += `<div class="list-item"><div class="main-content"><div class="list-item-name">${item.name}</div></div><div class="store-actions"><button class="icon-btn" onclick="vibrate(); editItem(${item.id})">${icons.edit}</button><button class="icon-btn danger" onclick="vibrate(100); deleteItem(${item.id})">${icons.trash}</button></div></div>`;
                });
                html += `</div>`;
            }
            container.innerHTML = html;
        };

        const renderShopping = async (container) => {
            const list = await dbOps.get('lists', currentList);
            const store = await dbOps.get('stores', list.storeId);
            const listItems = await dbOps.getByIndex('listItems', 'listId', currentList);
            const storeItems = await dbOps.getByIndex('items', 'storeId', store.id);
            let itemsWithDetails = await Promise.all(listItems.map(async li => ({ ...li, ...(await dbOps.get('items', li.itemId)) })));
            if (currentSort === 'alpha') itemsWithDetails.sort((a, b) => a.name.localeCompare(b.name));
            else itemsWithDetails.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
            const checkedCount = itemsWithDetails.filter(i => i.checked).length;
            const total = itemsWithDetails.reduce((sum, item) => sum + (parseFloat(item.price) * (item.quantity || 1) || 0), 0);
            const existingItemIds = listItems.map(li => li.itemId);
            const availableItems = storeItems.filter(item => !existingItemIds.includes(item.id));
            
            let html = `<div class="shopping-header"><div class="shopping-store-name">${icons.store} ${store.name}</div><div class="shopping-stats"><span class="shopping-stat">${icons.checkCircle} ${checkedCount}/${itemsWithDetails.length}</span>${total > 0 ? `<span class="shopping-stat">${icons.dollarSign} ${total.toFixed(2)}</span>` : ''}</div></div><div class="quick-add-form"><form id="quickAddForm" style="margin: 0;"><div class="quick-add-input"><input type="text" class="form-input" id="quickAddItem" list="quickItemsList" placeholder="Add item..." autocomplete="off" style="margin: 0;"><datalist id="quickItemsList">${availableItems.map(item => `<option value="${item.name}">${item.name} (${item.category})</option>`).join('')}</datalist><button type="submit" class="quick-add-btn">${icons.plus} Add</button></div></form></div>`;
            
            if (itemsWithDetails.length === 0) {
                html += `<div class="empty-state" style="padding: 40px 20px;"><div class="empty-state-icon">${icons.cart}</div><div class="empty-state-text">Your list is empty<br>Add items above to get started</div></div>`;
            } else {
                html += `<div class="shopping-controls"><button class="sort-btn" onclick="toggleSort()">${icons.sort} Sort by ${currentSort === 'category' ? 'Name' : 'Category'}</button></div>`;
                const itemsByCategory = {};
                itemsWithDetails.forEach(item => { const key = currentSort === 'category' ? item.category : 'All Items'; (itemsByCategory[key] = itemsByCategory[key] || []).push(item); });
                for (const category of Object.keys(itemsByCategory).sort()) {
                    html += `<div class="category-section"><div class="category-header">${category}</div>`;
                    itemsByCategory[category].forEach(item => {
                        html += `<div class="list-item ${item.checked ? 'checked' : ''}"><div class="checkbox ${item.checked ? 'checked' : ''}" onclick="toggleItem(${item.id})">${item.checked ? icons.check : ''}</div><div class="main-content" onclick="editListItem(${item.id})"><div class="list-item-content"><div class="list-item-name">${item.name}</div>${item.quantity && item.quantity != 1 ? `<div class="list-item-quantity">x${item.quantity}</div>` : ''}</div><div class="list-item-details">${item.price ? `<span>${icons.dollarSign} ${parseFloat(item.price).toFixed(2)}</span>` : ''}${item.notes ? `<span class="list-item-notes">${icons.messageSquare} ${item.notes}</span>` : ''}</div></div></div>`;
                    });
                    html += `</div>`;
                }
            }
            html += `<div style="margin-top: 24px;"><button class="btn btn-success" onclick="completeList()">${icons.check} Complete Shopping</button></div>`;
            container.innerHTML = html;
            document.getElementById('quickAddForm').addEventListener('submit', quickAddItem);
        };
        
        const toggleSort = () => { vibrate(); currentSort = currentSort === 'category' ? 'alpha' : 'category'; renderPage(); };

        const showModal = (title, content) => {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `<div class="modal-drag-handle"></div><div class="modal-header"><div class="modal-title">${title}</div><button class="close-btn" onclick="closeModal()">×</button></div>${content}`;
            modal.classList.add('active');
        };

        const closeModal = () => { document.getElementById('modal').classList.remove('active'); };

        const showCreateStoreModal = () => {
            const content = `<form onsubmit="createStore(event)"><div class="form-group"><label class="form-label">Store Name</label><input type="text" class="form-input" id="storeName" required></div><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="storeCategory" required>${DEFAULT_STORE_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select></div><button type="submit" class="btn btn-primary">Create Store</button></form>`;
            showModal('New Store', content);
        };

        const showCreateListModal = async () => {
            try {
                const stores = await dbOps.getAll('stores');
                if (stores.length === 0) {
                    showModal('No Stores Available', `<p style="margin-bottom: 20px; color: var(--gray-600);">You need to create a store first.</p><button class="btn btn-primary" onclick="vibrate(); navigate('stores'); closeModal();">Go to Stores</button>`); return;
                }
                const openLists = (await dbOps.getAll('lists')).filter(l => l.status === 'open');
                const availableStores = stores.filter(store => !openLists.some(list => list.storeId === store.id));
                if (availableStores.length === 0) {
                    showModal('No Stores Available', `<p style="margin-bottom: 20px; color: var(--gray-600);">All stores already have active shopping lists.</p><button class="btn btn-secondary" onclick="closeModal()">OK</button>`); return;
                }
                const content = `<form onsubmit="createList(event)"><div class="form-group"><label class="form-label">Select Store</label><select class="form-select" id="listStore" required><option value="">Choose a store...</option>${availableStores.map(store => `<option value="${store.id}">${store.name}</option>`).join('')}</select></div><button type="submit" class="btn btn-primary">Create List</button></form>`;
                showModal('New Shopping List', content);
            } catch (error) { console.error("Error showing create list modal:", error); alert("Could not load data to create a list."); }
        };

        const showAddItemModal = async () => {
            const categories = await dbOps.getAll('categories');
            const content = `<form onsubmit="addItemToStore(event)"><div class="form-group"><label class="form-label">Item Name</label><input type="text" class="form-input" id="itemName" required></div><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="itemCategory" required>${categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('')}</select></div><button type="submit" class="btn btn-primary">Add Item</button></form>`;
            showModal('Add Item', content);
        };

        const quickAddItem = async (e) => {
            e.preventDefault();
            vibrate();
            const searchValue = document.getElementById('quickAddItem').value.trim();
            if (!searchValue) return;
            try {
                const items = await dbOps.getByIndex('items', 'storeId', currentStore);
                const existingItem = items.find(item => item.name.toLowerCase() === searchValue.toLowerCase());
                let itemId;
                let itemData;
                if (existingItem) {
                    itemId = existingItem.id;
                    itemData = existingItem;
                } else {
                    itemData = { storeId: currentStore, name: searchValue, category: 'Other', lastPrice: null };
                    itemId = await dbOps.add('items', itemData);
                }
                const existingListItems = await dbOps.getByIndex('listItems', 'listId', currentList);
                if (existingListItems.some(li => li.itemId === itemId)) {
                    alert('This item is already on your list.');
                } else {
                    await dbOps.add('listItems', { listId: currentList, itemId: itemId, checked: false, price: itemData.lastPrice || null, quantity: 1, notes: '' });
                }
                document.getElementById('quickAddItem').value = '';
                await renderPage();
            } catch (error) { console.error('Failed to add item:', error); alert('An error occurred while adding the item.'); }
        };

        const editListItem = async (listItemId) => {
            vibrate();
            const listItem = await dbOps.get('listItems', listItemId);
            const item = await dbOps.get('items', listItem.itemId);
            const content = `<form onsubmit="updateListItem(event, ${listItemId})"><div class="form-group"><label class="form-label">Quantity</label><input type="text" class="form-input" id="itemQuantity" value="${listItem.quantity || '1'}" placeholder="e.g., 1, 2.5, 1kg"></div><div class="form-group"><label class="form-label">Price (per item)</label><input type="number" step="0.01" class="form-input" id="itemPrice" value="${listItem.price || ''}" placeholder="0.00"></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="itemNotes" placeholder="e.g., brand preference, low-fat...">${listItem.notes || ''}</textarea></div><div class="btn-row"><button type="button" class="btn btn-danger" onclick="vibrate(100); deleteListItem(${listItemId})">${icons.trash} Remove</button><button type="submit" class="btn btn-primary">${icons.check} Save</button></div></form>`;
            showModal(`Edit: ${item.name}`, content);
        };
        
        const updateListItem = async (e, listItemId) => {
            e.preventDefault();
            vibrate();
            const listItem = await dbOps.get('listItems', listItemId);
            const price = document.getElementById('itemPrice').value;
            listItem.price = price;
            listItem.quantity = document.getElementById('itemQuantity').value || '1';
            listItem.notes = document.getElementById('itemNotes').value;
            await dbOps.update('listItems', listItem);

            if (price) {
                const item = await dbOps.get('items', listItem.itemId);
                item.lastPrice = price;
                await dbOps.update('items', item);
            }

            closeModal();
            renderPage();
        };

        const viewCompletedList = async (listId) => {
            vibrate();
            const list = await dbOps.get('lists', listId);
            const store = await dbOps.get('stores', list.storeId);
            const listItems = await dbOps.getByIndex('listItems', 'listId', listId);
            const itemsWithDetails = await Promise.all(listItems.map(async li => ({ ...li, ...(await dbOps.get('items', li.itemId)) })));
            const total = itemsWithDetails.reduce((sum, item) => sum + (parseFloat(item.price) * (item.quantity || 1) || 0), 0);
            const itemsByCategory = {};
            itemsWithDetails.forEach(item => { (itemsByCategory[item.category] = itemsByCategory[item.category] || []).push(item); });
            let itemsHtml = '';
            for (const category of Object.keys(itemsByCategory).sort()) {
                itemsHtml += `<div class="category-header">${category}</div>`;
                itemsByCategory[category].forEach(item => {
                    const displayPrice = item.price ? (parseFloat(item.price) * (item.quantity || 1)).toFixed(2) : '';
                    itemsHtml += `<div class="list-item"><div class="main-content"><div class="list-item-content"><div class="list-item-name">${item.name}</div>${item.quantity && item.quantity != 1 ? `<div class="list-item-quantity">x${item.quantity}</div>` : ''}</div>${item.notes ? `<div class="list-item-details" style="margin-top: 4px; opacity: 0.8;">${item.notes}</div>` : ''}</div>${displayPrice ? `<div class="list-item-price">${displayPrice}</div>` : ''}</div>`;
                });
            }
            const content = `<div style="margin-bottom: 20px;"><div style="font-weight: 600; color: var(--gray-700); margin-bottom: 4px;">${icons.store} ${store.name}</div><div style="font-size: 14px; color: var(--gray-600); display: flex; align-items: center; gap: 4px;">${icons.clock} ${formatDateTime(list.completedAt)}</div>${total > 0 ? `<div style="font-size: 20px; font-weight: 700; color: var(--primary); margin-top: 12px; display: flex; align-items: center; gap: 6px;">${icons.dollarSign} ${total.toFixed(2)}</div>` : ''}</div>${itemsHtml}<div class="btn-row" style="margin-top: 24px;"><button class="btn btn-secondary" onclick="vibrate(); reuseList(${list.id})">${icons.repeat} Re-use List</button><button class="btn btn-danger" onclick="vibrate(100); deleteList(${listId})">${icons.trash} Delete</button></div>`;
            showModal('Shopping List', content);
        };
        
        const reuseList = async (listId) => {
            const oldList = await dbOps.get('lists', listId);
            const allLists = await dbOps.getAll('lists');
            if (allLists.some(l => l.storeId === oldList.storeId && l.status === 'open')) {
                alert('An active list already exists for this store.'); return;
            }
            const oldListItems = await dbOps.getByIndex('listItems', 'listId', listId);
            const newListId = await dbOps.add('lists', { storeId: oldList.storeId, status: 'open', createdAt: new Date().toISOString(), completedAt: null });
            for (const item of oldListItems) {
                const mainItem = await dbOps.get('items', item.itemId);
                await dbOps.add('listItems', { listId: newListId, itemId: item.itemId, checked: false, price: mainItem.lastPrice || null, quantity: item.quantity, notes: item.notes });
            }
            closeModal(); openList(newListId);
        };

        const createStore = async (e) => { e.preventDefault(); vibrate(); await dbOps.add('stores', { name: document.getElementById('storeName').value, category: document.getElementById('storeCategory').value }); closeModal(); renderPage(); };
        const editStore = async (storeId) => { vibrate(); const store = await dbOps.get('stores', storeId); const content = `<form onsubmit="updateStore(event, ${storeId})"><div class="form-group"><label class="form-label">Store Name</label><input type="text" class="form-input" id="storeName" value="${store.name}" required></div><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="storeCategory" required>${DEFAULT_STORE_CATEGORIES.map(cat => `<option value="${cat}" ${cat === store.category ? 'selected' : ''}>${cat}</option>`).join('')}</select></div><button type="submit" class="btn btn-primary">Update Store</button></form>`; showModal('Edit Store', content); };
        const updateStore = async (e, storeId) => { e.preventDefault(); vibrate(); await dbOps.update('stores', { id: storeId, name: document.getElementById('storeName').value, category: document.getElementById('storeCategory').value }); closeModal(); renderPage(); };
        const deleteStore = async (storeId) => { if (confirm('Delete this store? All items and lists will be removed.')) { const items = await dbOps.getByIndex('items', 'storeId', storeId); for (const item of items) await dbOps.delete('items', item.id); const lists = await dbOps.getByIndex('lists', 'storeId', storeId); for (const list of lists) { const listItems = await dbOps.getByIndex('listItems', 'listId', list.id); for (const li of listItems) await dbOps.delete('listItems', li.id); await dbOps.delete('lists', list.id); } await dbOps.delete('stores', storeId); renderPage(); } };
        const createList = async (e) => { e.preventDefault(); vibrate(); const storeId = parseInt(document.getElementById('listStore').value); if (!storeId) return; const listId = await dbOps.add('lists', { storeId, status: 'open', createdAt: new Date().toISOString(), completedAt: null }); closeModal(); openList(listId); };
        const addItemToStore = async (e) => { e.preventDefault(); vibrate(); await dbOps.add('items', { storeId: currentStore, name: document.getElementById('itemName').value, category: document.getElementById('itemCategory').value, lastPrice: null }); closeModal(); renderPage(); };
        const editItem = async (itemId) => { vibrate(); const item = await dbOps.get('items', itemId); const categories = await dbOps.getAll('categories'); const content = `<form onsubmit="updateItem(event, ${itemId})"><div class="form-group"><label class="form-label">Item Name</label><input type="text" class="form-input" id="itemName" value="${item.name}" required></div><div class="form-group"><label class="form-label">Category</label><select class="form-select" id="itemCategory" required>${categories.map(cat => `<option value="${cat.name}" ${cat.name === item.category ? 'selected' : ''}>${cat.name}</option>`).join('')}</select></div><button type="submit" class="btn btn-primary">Update Item</button></form>`; showModal('Edit Item', content); };
        const updateItem = async (e, itemId) => { e.preventDefault(); vibrate(); const item = await dbOps.get('items', itemId); await dbOps.update('items', { ...item, name: document.getElementById('itemName').value, category: document.getElementById('itemCategory').value }); closeModal(); renderPage(); };
        const deleteItem = async (itemId) => { if (confirm('Delete this item?')) { await dbOps.delete('items', itemId); renderPage(); } };
        const toggleItem = async (listItemId) => { vibrate(); const listItem = await dbOps.get('listItems', listItemId); listItem.checked = !listItem.checked; await dbOps.update('listItems', listItem); renderPage(); };
        const deleteListItem = async (listItemId) => { if (confirm('Remove this item from the list?')) { await dbOps.delete('listItems', listItemId); closeModal(); renderPage(); } };
        const completeList = async () => { if (confirm('Mark this shopping trip as complete?')) { vibrate(); const list = await dbOps.get('lists', currentList); list.status = 'completed'; list.completedAt = new Date().toISOString(); await dbOps.update('lists', list); navigate('home'); } };
        const deleteList = async (listId) => { if (confirm('Delete this list permanently?')) { const listItems = await dbOps.getByIndex('listItems', 'listId', listId); for (const li of listItems) await dbOps.delete('listItems', li.id); await dbOps.delete('lists', listId); closeModal(); navigate('history'); } };
        const openList = (listId) => { vibrate(); dbOps.get('lists', listId).then(list => { currentList = listId; currentStore = list.storeId; navigate('shopping'); }); };
        const viewStoreItems = (storeId) => { vibrate(); currentStore = storeId; navigate('store-items'); };
        const formatDate = (dateStr) => { const date = new Date(dateStr); const today = new Date(); const diffDays = Math.floor((today - date) / 864e5); if (diffDays === 0) return 'Today'; if (diffDays === 1) return 'Yesterday'; if (diffDays < 7) return `${diffDays} days ago`; return date.toLocaleDateString(); };
        const formatDateTime = (dateStr) => { const date = new Date(dateStr); return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); };

        document.querySelectorAll('.nav-item').forEach(item => { 
            if (item.id !== 'add-nav-btn') {
                item.addEventListener('click', (e) => { vibrate(); navigate(e.currentTarget.dataset.page); });
            }
        });
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        
        const startApp = async () => {
            try {
                await initDB();
                await initCategories();
                await renderPage();
                const loadingIndicator = document.getElementById('loading-indicator');
                loadingIndicator.style.opacity = '0';
                setTimeout(() => loadingIndicator.remove(), 300);
            } catch (error) {
                console.error("Fatal error during app initialization:", error);
                document.getElementById('mainContainer').innerHTML = `<div class="empty-state"><div class="empty-state-text" style="color: var(--danger);">A critical error occurred. Please clear your browser cache and try again.</div></div>`;
                const loadingIndicator = document.getElementById('loading-indicator');
                if(loadingIndicator) loadingIndicator.remove();
            }
        };

        startApp();
    </script>
</body>
</html>
